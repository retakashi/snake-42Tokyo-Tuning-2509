## 2. データベースのインデックスとは？

---

### 目次
- [1 インデックスってなに？](#1-インデックスってなに)  
- [2 どうやって速くなるの？](#2-どうやって速くなるの)  
- [3 どんなときに使うの？](#4-どんなときに使うの)  
- [4 インデックスの作り方・調べ方（MySQL）](#5-インデックスの作り方調べ方mysql)  
- [5 どこにインデックスを貼ればいいか考えるヒント](#6-どこにインデックスを貼ればいいか考えるヒント)

---

### 1 インデックスってなに？

インデックスは、**データベースの検索を速くするためのしくみ**です。

イメージで言うと、本の索引のようなものです。

- インデックスがある → すぐに探せる（ページ数が分かる）  
- インデックスがない → 最初から全部読む（時間がかかる）

---

### 2 インデックスのいいところ・悪いところ

| メリット | デメリット |
|--------|--------|
| 検索が速くなる | データの登録や更新が少し遅くなる |
| データがたくさんあっても大丈夫 | ディスク容量が少し増える |
| ソートや結合も速くなることがある | インデックスの作りすぎは逆効果になることも |

---

### 3 どんなときに使うの？

インデックスは、こんなときに使うと効果的です：

- **WHERE句**でよく使うカラム  
  例：`WHERE email = 'xxx@example.com'`

- **JOIN**で使うカラム  
  例：`JOIN orders ON users.id = orders.user_id`

- **ORDER BY** や **GROUP BY** で使うカラム  
  例：`ORDER BY created_at DESC`

---

### 4 インデックスの作り方・調べ方（MySQL）

#### ✅ インデックスを作るには

```sql
CREATE INDEX idx_users_email ON users(email);
```

#### ✅ 作ったインデックスを確認する

```sql
SHOW INDEX FROM users;
```

#### ✅ クエリの実行計画を確認する

```sql
EXPLAIN SELECT * FROM users WHERE email = 'test@example.com';
```

> `type` が `ALL` の場合は「全件スキャン（遅い）」になっています。  
> `ref` や `const` などになっていれば、インデックスが使われている状態です。  
> `rows` の数字が少ないほど、効率的にデータが取れていることを意味します。

---

### 5 どこにインデックスを貼ればいいか考えるヒント

インデックスは「なんとなく貼る」のではなく、**パフォーマンス低下の原因を特定した上で貼る**のが重要です。

以下の流れで考えてみましょう：

1. **Jaegerで遅い処理を見つける**  
   どのリクエスト・どのクエリで時間がかかっているかを確認します。

2. **遅いクエリのWHERE句に注目**  
   クエリの中で `WHERE` や `JOIN` に使われているカラムをチェックします。

3. **インデックスが貼られているか確認する**

```sql
SHOW INDEX FROM テーブル名;
```

4. なければインデックスを作成して試す
```sql
CREATE INDEX インデックス名 ON テーブル名(カラム名);
```

5. `EXPLAIN`で効果が出ているか確認する
```sql
EXPLAIN SELECT ...;
```

---

#### 💡 複合インデックスについて

1つのインデックスに**複数のカラムをまとめること**もできます。これを「複合インデックス」と言います。

```sql
CREATE INDEX idx_orders_user_id_status ON orders(user_id, status);
```

このようにすると、次のようなクエリが高速化できます：

```sql
SELECT * FROM orders WHERE user_id = 123 AND status = 'shipped';
```

> ⚠️ 複合インデックスでは、**カラムの順序が検索効率に大きく影響します**。  
> 上の例では、`user_id` を先に、次に `status` を条件にする必要があります。
